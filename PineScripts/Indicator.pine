// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © jinni-main

//@version=5
indicator(title = "Jinni v1", shorttitle="Jinni", overlay=true)
ema1 = input(36,title="EMA UpTrend")
shema = input(true, title="Show EMA Trend is Based On?")

length = input.int(title="Length", defval=5, minval=1)
atr = ta.rma(ta.tr(true), length) > 0.0075

len = input.int(75, minval=1, title="Length")
src = input(close, title="Source")
offset = input.int(title="Offset", defval=0, minval=-500, maxval=500, display=display.data_window)
ema = ta.ema(src, len)

sesd_ses = input.session('2100-0600')
tz_incr = input.int(0)
use_exchange = input(false)
tf = timeframe.period
tz = use_exchange ? syminfo.timezone : str.format('UTC{0}{1}', tz_incr >= 0 ? '+' : '-', math.abs(tz_incr))
syd = time(tf, sesd_ses, tz) != 0

usedEma = ta.ema(close, ema1)

emaU = ema < close and ema < open
emaD = ema >= close and ema >= open

cmUp = (close >= usedEma) and ((close[1] >= usedEma) and (close > close[1])) and (open >= usedEma) and not syd and atr and emaU 
cmDown = (close < usedEma) and (close[1] < usedEma and (close < close[1])) and (open < usedEma) and not syd and atr and emaD

cmUclose = (close < usedEma) and (close[1] < usedEma) and not syd and emaU
cmDclose = (close >= usedEma) and ((close[1] >= usedEma)) and emaD and not syd

var bool cmuflg = na
var bool cmdowflg = na

if cmUp
    cmuflg := true
    cmDown := false
else if cmDown
    cmdowflg := true
    cmuflg := false
else if syd
    cmuflg := false
    cmdowflg := false
else 
    cmuflg := false
    cmdowflg := false



plotshape(series=cmuflg and not cmUclose, location=location.belowbar, color=#15ff00, style=shape.triangleup, size=size.small, title="Buy Signal")
plotshape(series=cmdowflg and not cmDclose, location=location.abovebar, color=#ff9a3b, style=shape.triangledown, size=size.small, title="Sell Signal")

plotshape(series=cmUclose, location=location.belowbar, color=color.blue, style=shape.triangleup, size=size.small, title="Buy Signal")
plotshape(series=cmDclose, location=location.abovebar, color=color.yellow, style=shape.triangledown, size=size.small, title="Sell Signal")